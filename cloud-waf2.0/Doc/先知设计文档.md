# 权限设计   
## 1.数据库设计

### 1.1共有表
    rule_opt_log:{//日志规则表  在此表内的操作都会自动化记录日志
        "_id" : "Admin/Login/login", 需要记录日志的action
        "log_code" : NumberLong(1), 成功的返回码标志位
        "name" : "用户登录"          日志类型名

    }
    
    rule_cache:{//缓存规则表 在此表内的操作都会执行自动化缓存
         "_id" : "Admin/Login/login", 需要缓存的action
        "name" : "首页SUMMARY"         缓存别名型名
    
    }

     region:自有域
    {
        _id:pk,
        name_cn:名称,
        name_en:别名(唯一),
        industry:行业归属(暂定为 org edu),
        location:array(
            province:省份归属,
            city:城市归属,
            district:地县归属
        ),
        admin_location:array(
        	province:行政省份,
        	city:行政城市,
        	district:行政区县
        ),
        init:1,  （1:等待初始化 2:正在初始化 3.已经初始化  -1 等待销毁  -3 已逻辑销毁）
        view_config:{
        	location_type:先知大屏视图中的归属类型 默认按行政归属统计
        	deep_type:下钻层级 地市/区县 默认到区县级	
        		
        }
        
        
       
        desc:描述
    }
        
    auth_action:操作权限列表
    {
        _id:pk,
         name:操作url值,
         title:操作名称
         is_menu:1/0 是否在菜单中显示,
         pid:父id,
         seq:加载顺序,
         child_actions:子权限
         status:1/0 启用/禁用
    }
        
    auth_user:admin用户或者全局用户
    {
        _id:pk,
        username:用户名,
        name:用户姓名,
        password:密码,
        email:邮箱,
        phone:手机号
    }
      
    user_r_region:用户_域_关系表
    {
        _id:username,
        region:域_id号
    }
    
    asset_mapper:{//资产和域的映射表 ,1表示 该域中包含该网站
    	_id:domain,
    	reflect:{
    		region_1:1,
    		region_2:1,
    		region_3:0
    	}
    
    }
    export_task:{ 异步文件导出任务表
       _id:pk,
       uid:创建者,
       rid:所属域,
       name:"别名",
       fileName:"要生成文件名",
       time:"导出时间",
       tiemstamp:时间戳,
       fullFile:服务端文件保存全路径,
       task_type:导出类型  1:资产导出 2资产报告导出 …………
       field:array(), 要导出的字段
       params:array(), 导出时候的查询条件
       status：1:等待 2:进行中 3:完成
       progress:array() 导出进度

    }
    

    


### 1.2域内表
    
    auth_role:
    {
        _id:pk,
        name:角色名称,
        rules:array() 操作权限规则列表
    }
    
    auth_user:域内用户表
    {
        _id:pk,
        username:用户名,
        name:用户姓名,
        password:密码,
        email:邮箱,
        phone:手机号,
        is_manager:1/0 是否是域内管理员(由且只有一个)
        
    }
    
	asset:资产表
	{
		_id:域名,
		title:标题,
		ip:"ip1,ip2,ip3",
		location:{  //IP归属
			province:"省份",
			city:"城市",
			district:"区县"
		},
		admin_location:{  //行政归属
			province:"省份",
			city:"城市",
			district:"区县"
		},
		finger:{  //指纹
			os:"操作系统",
            thirdparty:"第三方组件",
            waf:"waf",
            framework:"框架",
            webapp:"cms",
            frontend:"前端框架",
            server:"web容器",
            component:"其他组件"
			
		},
		whois:{
			registrant_name:注册人姓名,
			registrant_email:注册人邮箱,
			registrar_server:注册服务商,
			registration_date:注册日期,
			expiration_date:过期时间
		},
		vuls:{
            level:网站等级,
            level_detail:{
                high:"高危等级漏洞个数",
                …………
                info:""
            },
            sd_detail:{各类型漏洞个数
                SD0001:10,
                …………
            }
        },
        survey:{
            visit_data:{//各个节点的普查情况
            },	
            "visit_last" : "四川",//最后一次返回数据的节点
		    "visitable" : 1// 1:可访问 0:不可访问
		    "visit_state:" -1:响应超好时/-2:找不到资源/-3:服务异常/-4:僵尸网站
            
            
        },
        serurity:{//安全事件
           
        
        }
	
	}
	
	event:{
	    安全事件详情表
	}
	
    opt_log:{ //操作日志表
       	"_id" : pk,
	    "name" : "用户登录",
	    "success" : 1 成功/0 失败,
	    "param" : { //完整操作结果参数
		    "code" : NumberLong(1),
		    "msg" : "登录成功",
		    "firstAction" : "Home/HomePage/index"
	    },
	    "uid" : 操作用户,
	    "time" : "2016-04-14 11:17:32",//操作时间
	    "ip" : "192.168.28.43"//操作者IP

    
    }
    
    stats_vuls//先知视图 漏洞预统计表
    stats_finger//先知视图 指纹数据预统计表
    stats_survey//先知视图 网站普查预统计表
    stats_zeroday//先知视图 0day预统计表

	
	
    
    
## 2.操作流程-系统管理

###2.0登录
        0)域内用户只能进入自有域,admin用于和全局用户可以自由切换域(充当域内超级管理员的角色)进行管理
        1)域内用户:输入用户名和密码直接进入自有域
        2)admin用户或者全局用户(全局用户的添加尚未支持):输入用户名和密码,当通过验证的时候,会提示选择要进入的某个自有域

    

### 2.1域管理

    2.1.1添加域
        0) admin的初始密码为123456
        1) 域只能有admin用户添加和管理，该菜单在系统管理下只有admin可见
        2) 域被添加后会自动生成一个域管理员(唯一) 管理员的用户名: 域别名_manager 密码:随机(创建成功时候会回显一次)
        
           如果域管理员密码忘记，可以通过《重置域管理员》重置管理员密码
        3)资产范围:在域名类型和归属条件中 至少可选择一种
        4)域的初始化:如果在初始化选项上选择“是“ 会后台异步执行初始化,前端显示初始化进度
        5）当天初始化完毕的域 需要到第二天才能看到漏洞数据和先知页面的统计数据(后期会处理成域生成完 立即同步一次和统计一次)
          
    
    2.1.2修改域
        域别名不可修改,其他可改
    
    2.1.3重置域管理员
        重置管理员密码
        
    2.1.4设置域视图
    	先知大屏的视图参数设置
    	    
        
    2.1.5删除域
        某个自由域将被删除，不可恢复,请慎重操作  后端异步执行域销毁的后续操作
    
### 2.2 角色管理

    2.2.1添加/修改角色
        添加/修改角色

    2.2.2删除角色
        注意:角色删除后 请对原本属于该角色的用户赋予新的角色
   
### 2.3 用户管理
    
    
    2.3.1添加用户
        0)用户名全系统内唯一：所以为了防止和其他域内的用户的用户名冲突，请尽量使用手机号(非强制)
        1)手机号必须填写:后期可能用于登录时候的认证功能
        2)角色可多选
        3)密码随机生成:创建时候回显一次,如果该用户忘记密码,可以由管理员 重置该用户的随机密码
    
    2.3.2修改用户
        修改用户
    
    2.3.3删除用户
        删除用户
    
#### 2.3.4重置密码
    
    重置用户密码
    
    

### 2.4其他

    2.4.1 个人设置
        0)如果填写了新密码,代表希望修改密码,此时要求旧密码正确,两次密码一致
        1)要求重新登陆生效
        
    2.4.2 切换域
        1)只有admin用户和全局用户有此菜单项,可以自由切换域(充当域内超级管理员的角色)进行管理
        2)目前尚未支持全局用户的添加
        
    2.4.3 退出系统
        退出系统返回登陆页
        

##3.资产管理
        
### 3.1资产管理
	
	3.1.1 添加资产 暂不支持
	3.1.2 修改资产 除了域名其他都可以修改 并会在点击保存后在数据中新增一个edited=1的字段,防止被自动更新覆盖
	3.1.3 导出excel:基于查询异步导出excel，可选字段只有资产基础数据
	
##4.信息中心
### 4.1先知
	4.1.1 配置:在域的添加和修改的时候可以配置先知入口、下钻等级 以及归属设置，不同的设置在先知界面展示也不同
	4.1.2 支持基于云端的0day 配置
	
##5 安全资讯
    5.1 安全资讯的来源为云端接口
    
##6 站点报告
### 6.1站点报告
    6.1.1支持多维度查询
    6.1.2导出excel:基于查询异步导出excel，可选字段包括基础数据、漏洞数据、安全事件、网站普查

##7 工作台
    7.1 提供历史导出任务查询和下载

## 0.数据引擎（java）

### 0.1域初始化和域销毁管理器:RegionInitManager
	 	
	0.1.1 域初始化
		 0)操作对象：刚创建待初始化的域
		 1)操作过程: 域状态置为正在初始化,从数据中心异步分页获取所需数据，并在共享表asset_mapper中添加映射
		 2)完成: 域状态置为正在初始化完毕
		
    0.1.2 域销毁
    	 0)操作对象:等待销毁的域
    	 1)共享表asset_mapper中移除映射
    	 2)删除域
    	 
### 0.2数据同步管理器:syncManager
	
	0.2.1 数据同步
		0)分页查询asset_mapper表,通过域名从大数据查询网站详单,包括网站的基础数据、漏洞数据、网站普查数据
		1）通过asset_mapper表中的映射关系更新各个域中该网站的漏洞数据、普查数据 基础数据,如果该该站被用户编辑过,则不更新基础数据
		
### 0.3数据统计管理器 statsManager

	0.3.1 数据统计
	
		0)基于js驱动脚本,对每个域中的资产做定向统计(先知大屏)		1)后期可基于js驱动针对域内的数据做多维度的定向数据报告
		
		时间值预估: 32W量的全国+各省域统计时间大概在半分钟左右(多次验证) 这一块在速度比原来的方式块了上千倍
					城市和区县的统计 由前端动作触发统计+数据缓存(这类数据的统计时间已经完全<1秒)  
					实际上对于一些小型域 甚至全国和各个省份的预统计都可以不要
		实时性预估: 最大延迟周期为1天 
		
	
### 0.4数据异步生成器 AbstractExportTask

    0.4.1 AbstractExportTask作为异步导出的基类,ExportCallback作为异步进度回调,所有的导出功能都基于实现以上2个类完成
			
			
			
				 
    	  	

       

    